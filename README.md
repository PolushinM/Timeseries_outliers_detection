### Исследование возможности построения детектора аномального поведения химического оборудования по timeseries сигналам с датчиков температуры.

### Задача:
На основании предоставленного дата сета построить модель для прогнозирования нормальной работы системы на 1 точку вперед.
Предусмотреть оптимальный размер (количество точек):
- обучающей выборки.
- выборки для построение выходного сигнала.

##### Ожидаемый результат:
Ожидаемое значение прогноза должно находиться в диапазоне +/- 1 градус от фактического значения параметра.

##### Способ проверки:
Проверка модели (на свежих данных или в режиме онлайн) на:
- отсутствие ложных срабатываний в обычном режиме;
- контроль отдельных выбросов;
- контроль скорости изменения процесса.

##### Дополнительная информация:
- В дата сете есть склейка данных, что может приводить к некорректному обучению модели.
- Рекомендация использовать связку датчик + режим работы
- Оптимизация (снижение ресурсоемкости решения) приветствуется
- Для каждого датчика внутри «точки» предусмотрено измерение, минимального (ai * min), максимального (ai * max) и среднего значения (ai * mean), режим работы установки соответствует mode

##### Система (оборудование, на котором установленны датчики) должна поддерживать минимальную температуру раствора, при этом по технологии раствор перекачивается из второй емкости в первую, в течение часа с ним происходят манипуляции и далее он сливается в емкость номер 2, циркуляция между емкостями 1 и 2, цикл нахождение раствора в емкости 1 состовляет около часа (обычно).

### Подход к решению задачи:
Для того, чтобы понять суть происходящих в установке процессов, составил для себя вот такое описание:
- Mode=4: Начальное состояние системы. Бак №1 пуст, бак №2 наполнен, газ (датчики 1 и 2) в первом баке постепенно охлаждается до температуры примерно 24°С (вероятно, температура воздуха в цехе), скорость охлаждения пропорциональна разности температур. Температура в баке №2 поддерживается на уровне 34..36°C системой управления.
- Mode=1: В этом режиме жидкость перекачивается в бак №1. Пока уровень жидкости не достиг датчиков, температура в баке №1 продолжает приближаться к Тцеха, затем (жидкость доходит до датчика) резко начинает расти до Тпроцесса, на уровне около 35°. В баке №2 температура начинает быстро падать после того, как уровень жидкости опустится ниже датчика.
- Mode=2: Рабочий режим. Основной технологический процесс. В баке №1 поддерживается постоянная температура жидкости. В баке №2 температура газа быстро снижается.
- Mode=3: Перекачивание жидкости из бака №1 в бак №2. Температура в баке №1 снижается постепенно. В баке №2 температура испытывает резкий скачок вверх, когда жидкость достигает датчика.

#### Что может пойти не так:
- Mode=4: Выход температуры в баке №2 за установленные в системе управления температурой пределы (неисправность системы поддержания температуры), слишком медленный нагрев (неисправность нагревателя) жидкости в баке №2 или слишком быстрое её охлаждение (нарушение теплоизоляции). Несоответствие скорости охлаждения (нарушение теплоизоляции или неполное удаление продукта реакции) бака №1 текущей разности температур (температур в баке и в цехе).
- Mode=1: Переход от охлаждения к нагреву в баке №1 происходит позже обычного (недостаточная производительность насоса), необычная скорость нагрева или охлаждения в баке №1. Скачок температуры в баке №2 происходит позже обычного (недостаточная производительность насоса).
- Mode=2: Выход температуры в баке №1 за установленные в системе управления температурой пределы (неисправность системы поддержания температуры), слишком медленный нагрев (неисправность нагревателя) жидкости в баке №1 или слишком быстрое её охлаждение (нарушение теплоизоляции). Нетипичная скорость охлаждения в баке №2.
- Mode=3: Нетипичная скорость охлаждения в баке №1. Переход от охлаждения к нагреву в баке №2 происходит позже обычного (недостаточная производительность насоса).

#### Анализ полученных данных, основные проблемы и пути решения.
Я проанализировал распределения изменений температуры датчиков за одну минуту (шаг - минута, насколько понял). Большая часть из них равна нулю. \
Изменений больше 0.2°С почти нет, это очень редкое событие. Наблюдаются очень редкие скачки температуры датчиков 1 и 3. \
Датчики 1 и 3 измеряют температуру жидкости. Судя по принципу работы установки, скачки температуры более 0.2°С за минуту наблюдаются только в моменты, когда, при наполнении бака, жидкость касается датчика. \
Это является серьёзной проблемой для нас, так как мы собираемся делать выводы о режимах работы оборудования по абсолютному значению ошибки прогноза, и порогом выбран 1°C, а эта ошибка будет достигать значений порядка 1°С только в редкие моменты, когда уровень жидкости в баке достигает датчика. \
Если взять простейшую модель, которая "предсказывает", что следующее значение температуры равно предыдущему, то она дает R^2 > 99%, средняя абсолютная ошибка составляет для такой "модели" от 0.019°С до 0.054°С. Это очень мало, и означает, что наша система может срабатывать только в моменты, когда уровень жидкости достигает датчика 1 или 3. \
Во все остальные моменты, т.е. более 99.9% времени она будет "спать", и вряд ли сможет вообще заметить изменения.

#### Я предлагаю следующее решение.
Обучаем вторую модель, которая на основе информации о текущем режиме работы (режим Mode, время, которое прошло от начала текущего цикла, время, которое прошло от последнего начала каждого режима, можно добавить сглаженное значение температуры) прогнозирует абсолютное значение ошибки. \
Далее, мы сравниваем фактическое абсолютное значение ошибки первой модели с прогнозом второй модели (будет какой-то порог), и если фактическое значение намного больше прогнозного, считаем эту точку отклонением. \
Для того чтобы сделать систему более устойчивой и чувствительной к медленному изменению, можно ошибку сглаживать и накапливать при помощи скользящего среднего. \
Что мы получим: модель, прогнозирующая ошибку будет давать больший прогноз ошибки в периоды, когда наблюдаются быстрые изменения температуры, и меньшие для периодов, когда температура меняется медленно. \
Таким образом, мы сохраняем чувствительность в спокойных периодах и снижаем частоту ложных срабатываний при резких скачках. \
Я думаю, что такая схема работы даст намного больший прирост качества, чем использование сложной модели.

#### Выбор ML модели для прогнозирования:
Сигналы с датчиков температуры характеризуются тем, что их изменение очень сильно коррелирует с режимом работы (1, 2, 3 или 4), в котором находится оборудование, и с временем, которое прошло от начала текущего цикла. \
По субъективным ощущениям, в этом случае должны хорошо работать правила вида "ЕСЛИ (Mode=1) И (с начала цикла прошло N минут) И (температура ниже 36°С) И (температура начала повышаться только в последнюю минуту наблюдений, повышение составило 0.3°С) ТО ожидать повышения температуры в следующую минуту ещё на 1°С" и им подобным. Идеальным инструментом для автоматического построения множества подобных правил является градиентный бустинг на деревьях. \
Поэтому основной моделью машинного обучения выбрана GBMT, в качестве реализации GBMT взял CatBoost.

#### Реализация детектора аномалий со статическим порогом 1°С.
Так как динамический порог не реализован, проблема остаётся: модели очень сложно предсказывать момент, когда жидкость доходит до датчика, и происходит резкий скачок температуры. \
Наибольшая ошибка на кросс-валидации получилась около 1°C. \
В таком виде модель, по сути, обучается предсказывать именно эти несколько больших скачков, а на изменения поведения оборудования на спокойных участках реагировать будет слабо. \
Следовательно, обязательно надо попробовать сделать динамический порог (при помощи ещё одной модели) и обучать модель с L1 лоссом.

Модель (класс OutliersModel) устроена таким образом, что обучается сразу на наборе датасетов (метод fit принимает лист датафреймов), поэтому к датасету легко добавить любое количество не связанных между собой кусков, у меня в коде 3 куска (фолда). \
Для того чтобы бороться с переобучением на скачках температуры, добавил функцию аугментации данных (сдвиги, добавление max/min сигналов), это позволило несколько улучшить показатели. \
На выходе модель даёт трехмерный массив с прогнозами средних температур 'ai1 mean', 'ai2 mean', 'ai3 mean' на одну минуту вперед.

Оптимальный размер выборки для построения выходного сигнала сильно зависит от того, в каком режиме началась запись параметров. \
В среднем, для стабилизации работы модели нужны данные за 10-30 минут. В течение этих получаса она может давать больше ложных срабатываний в режимах 1 и 3.

#### Модель детекции аномалий с "динамическим порогом":
Стоит посмотреть на график ошибки модели и график условной ошибки при использовании второй модели, контролирующей ошибку. В первом случае - редкие большие выбросы только в определённых режимах работы. \
Во втором случае видно, что распределение намного более равномерное, а значит, модель будет чувствительна также и к изменению поведения системы в спокойных режимах 2 и 4. Возможно, что она сможет зафиксировать и небольшое изменение скорости нагрева/охлаждения.
![Static](https://github.com/PolushinM/Timeseries_outliers_detection/blob/main/Static.png)
![Dynamic](https://github.com/PolushinM/Timeseries_outliers_detection/blob/main/Dynamic.png)
